// SPDX-FileCopyrightText: 2025 StarkWare Industries Ltd.
//
// SPDX-License-Identifier: MIT

use crate::address::{Address, AddressTrait, AddressType};
use crate::fors::{ForsSignature, fors_pk_from_sig};
use crate::hasher::{
    HashOutput, compute_root, hash_message_128s, initialize_hash_function, thash_128s,
};
use crate::params_128s::{SPX_D, SPX_DGST_BYTES, SPX_TREE_HEIGHT};
use crate::word_array::{WordArrayTrait, WordSpan, WordSpanTrait};
use crate::wots::{WotsSignature, WotsSignatureDefault, WotsSignatureSerde, wots_pk_from_sig};

#[derive(Drop, Serde, Default, Copy)]
pub struct SphincsSignature {
    pub randomizer: HashOutput,
    pub fors_sig: ForsSignature,
    pub wots_merkle_sig_list: [WotsMerkleSignature; SPX_D],
}

#[derive(Drop, Serde, Default, Copy)]
pub struct SphincsPublicKey {
    pub pk_seed: HashOutput,
    pub pk_root: HashOutput,
}

#[derive(Drop, Serde, Default, Copy)]
pub struct WotsMerkleSignature {
    pub wots_sig: WotsSignature,
    pub auth_path: [HashOutput; SPX_TREE_HEIGHT],
}

#[derive(Drop)]
pub struct XMessageDigest {
    pub mhash: WordSpan,
    pub tree_address: u64,
    pub leaf_idx: u16,
}

/// Verify a signature for Sphincs+ instantiated with 128s parameters.
pub fn verify_128s(message: WordSpan, sig: SphincsSignature, pk: SphincsPublicKey) -> bool {
    let SphincsSignature { randomizer, fors_sig, wots_merkle_sig_list } = sig;
    let SphincsPublicKey { pk_seed, pk_root } = pk;

    // Seed the hash function state.
    let ctx = initialize_hash_function(pk_seed);

    // Initialize address
    let mut tree_addr: Address = Default::default();
    tree_addr.set_address_type(AddressType::HASHTREE);

    // Compute the extended message digest which is `mhash || tree_idx || leaf_idx`.
    let digest = hash_message_128s(randomizer, pk_seed, pk_root, message, SPX_DGST_BYTES);

    // Split the digest into the message hash, tree address and leaf index.
    let XMessageDigest {
        mhash, mut tree_address, mut leaf_idx,
    } = split_xdigest_128s(digest.span());

    let mut wots_addr: Address = Default::default();
    wots_addr.set_address_type(AddressType::WOTS);
    wots_addr.set_hypertree_addr(tree_address);
    wots_addr.set_keypair(leaf_idx);

    // Compute FORS public key (root) from the signature.
    let mut root = fors_pk_from_sig(ctx, fors_sig, mhash, @wots_addr);

    let mut layer: u8 = 0;
    let mut wots_merkle_sig_iter = wots_merkle_sig_list.span();

    while let Some(WotsMerkleSignature { wots_sig, auth_path }) = wots_merkle_sig_iter.pop_front() {
        tree_addr.set_hypertree_layer(layer);
        tree_addr.set_hypertree_addr(tree_address);

        wots_addr = tree_addr.clone();
        wots_addr.set_address_type(AddressType::WOTS);
        wots_addr.set_keypair(leaf_idx);

        let mut wots_pk_addr = wots_addr.clone();
        wots_pk_addr.set_address_type(AddressType::WOTSPK);

        // The WOTS public key is only correct if the signature was correct.
        // Initially, root is the FORS pk, but on subsequent iterations it is
        // the root of the subtree below the currently processed subtree.
        let wots_pk = wots_pk_from_sig(ctx, *wots_sig, root, @wots_addr);

        // Compute the leaf node using the WOTS public key.
        let leaf = thash_128s(ctx, @wots_pk_addr, wots_pk.span());

        // Compute the root node of this subtree.
        // Auth path has fixed length, so we don't need to assert tree height.
        root = compute_root(ctx, @tree_addr, leaf, auth_path.span(), leaf_idx.into(), 0);

        // Update the indices for the next layer.
        let (q, r) = DivRem::div_rem(tree_address, 0x200); // 1 << tree_height = 2^9 = 0x200
        tree_address = q;
        leaf_idx = r.try_into().unwrap();
        layer += 1;
    }

    // Check if the root node equals the root node in the public key.
    return root == pk_root;
}

/// Split the extended message digest into the message hash, tree address and leaf index.
/// NOTE: this is not a generic implementation, rather a shortcut for 128s.
fn split_xdigest_128s(mut digest: WordSpan) -> XMessageDigest {
    let (mut words, last_word, _) = digest.into_components();

    // Lead index is the 9 LSB of the last word (which is 2 bytes).
    let leaf_idx = last_word % 0x200;
    let leaf_idx: u16 = leaf_idx.try_into().expect('u32 -> u16 cast failed');

    // Tree address is the 54 LSB of the last two words.
    let lo = *words.pop_back().unwrap(); // 32 bits
    let ahi = *words
        .pop_back()
        .unwrap(); // 8 bits (mhash) | 2 bits (discarded) | 22 bits (tree_address)
    let (a, hi) = DivRem::div_rem(ahi, 0x400000);
    let tree_address = hi.into() * 0x100000000 + lo.into();

    // Message hash is the remaining 21 bytes.
    let mhash = WordSpanTrait::new(words.into(), a / 0x4, 1);

    XMessageDigest { mhash, tree_address, leaf_idx }
}

#[cfg(test)]
mod tests {
    use crate::word_array::WordArrayTrait;
    use crate::word_array::hex::{words_from_hex, words_to_hex};
    use super::*;

    #[test]
    fn test_split_xdigest_128s() {
        let digest = words_from_hex("5f6f74792de379a6337bbad9e4a1621e38c5e3827d8ae84c41501d68e961");
        let xdigest = split_xdigest_128s(digest.span());
        assert_eq!(xdigest.leaf_idx, 0x161);
        assert_eq!(xdigest.tree_address, 0xae84c41501d68);
        assert_eq!(words_to_hex(xdigest.mhash), "5f6f74792de379a6337bbad9e4a1621e38c5e3827d");
    }

    #[test]
    fn test_verify_128s() {
        let mut serialized_sig: Span<felt252> = array![
            3641804313, 3409659048, 1384169305, 4015803879, 3845349652, 3980556369, 2345842860,
            1383522053, 1776444148, 1913246444, 629880133, 807517995, 2489129527, 1704974249,
            4233369674, 1100003695, 670081949, 3229823586, 3156066271, 2877459785, 3864387640,
            962594578, 911814672, 2016832962, 1326981663, 3592066628, 3818678727, 2137522501,
            3663275941, 4067771361, 3694674432, 3684846138, 3702636245, 385802134, 609845906,
            984272547, 1305039906, 3897311913, 3980302792, 249601561, 1158118636, 956344437,
            1023701173, 1314681713, 1411960911, 3730304161, 2683139832, 3356909473, 2388706002,
            1141588912, 3659325720, 3077858432, 3527298358, 2314118033, 3980145040, 2123914386,
            3005460189, 799618523, 4283005829, 1963609509, 448973822, 3392281748, 1913893331,
            1146209971, 2311287984, 95487622, 4293653085, 2185286245, 811686332, 3733266479,
            2001227376, 1564350712, 3862241750, 2480308289, 75193294, 1827056948, 2444703908,
            1528035623, 252591360, 1907177532, 3276327886, 357642290, 1525373641, 4070846624,
            1600446942, 4172547367, 4117008599, 1992567557, 801700287, 3837426175, 785551454,
            2568300829, 4009686221, 2433702307, 2227486989, 3879962447, 2561294326, 678237389,
            172530358, 577304779, 3643678139, 2453705289, 1874419280, 1623797071, 1092834586,
            1903739565, 1410799062, 4024770158, 3336271720, 2140967539, 4161515794, 2279338650,
            3922117772, 480196858, 3429956549, 3334061486, 1012655393, 3493179932, 3313296442,
            709768141, 2211571227, 979080508, 2792618267, 667565804, 1849209463, 3482963173,
            445077236, 414976121, 4065588426, 4043683956, 1459517643, 2182497638, 2628200518,
            2917727800, 1546995338, 2885697989, 1916774556, 2508775278, 2112605576, 803353043,
            3461644707, 2838408325, 318400135, 3822977585, 2213848947, 1716372608, 1166639089,
            2946108606, 616994116, 1013459948, 2683935692, 4031717743, 2820540258, 3500500955,
            3109918323, 2974830952, 4154212888, 3354039323, 4223550271, 3540853557, 1791368236,
            1711818464, 1307829399, 1883320049, 2892567381, 375365615, 1058086475, 4153267831,
            4221916521, 2804585482, 3601002429, 2090616214, 3440304856, 309895163, 1339449254,
            2204032088, 2107709352, 3518617177, 2576130346, 179604206, 2048043515, 393494926,
            1492269847, 4016093241, 4137437153, 574991956, 694061486, 1823057853, 576105611,
            512463081, 685697519, 1774283082, 639106710, 2345765081, 1886027736, 3263890599,
            1688408216, 1657074873, 687351218, 1964933744, 249528114, 2000070167, 2159389206,
            1996532773, 1353612394, 3982165869, 2657885677, 2303272134, 2818163640, 4065756780,
            2738950354, 1956037779, 2414425867, 1973544800, 320170604, 925231311, 2455496728,
            2883443195, 1490713387, 3017823688, 4241218393, 2219148985, 628819248, 2939969314,
            177752055, 3578065884, 3905559371, 3368581155, 241040034, 911239107, 3435679378,
            1407384387, 1396365726, 3761063842, 11888979, 77084202, 2138333885, 236378764,
            2134882302, 1573999454, 1627819515, 3230097309, 3831670565, 2842829451, 4274748579,
            2240984806, 952818735, 388331066, 2632860657, 3349117205, 632606381, 3344410471,
            675067528, 2404347262, 1342305026, 2706079803, 475921287, 1677629046, 297106715,
            4240261903, 3540998797, 2364808562, 3756352841, 1918883116, 2524764992, 3020870704,
            680783868, 1458032803, 3355696017, 4108651072, 619123037, 3636910850, 38029166,
            889619814, 2779459159, 547835927, 3287886895, 410955316, 1583479435, 921168593,
            274504600, 1269870552, 630286762, 1614185261, 607438949, 685540797, 3031239454,
            375011737, 2988756236, 3398598350, 1321195186, 3196494495, 2851400759, 2336728473,
            190438675, 261435140, 1542519290, 2155683804, 1118260314, 3915141211, 2706284434,
            1463761718, 598597022, 718959274, 1040120845, 1653688289, 1646375500, 785395071,
            2582855538, 2950135274, 3120683159, 2438705142, 2562837108, 172083909, 3533122256,
            642625578, 1916636818, 3937105575, 978091614, 906286264, 3590166484, 686068513,
            1062386605, 3506372956, 690358374, 2836659061, 1544004463, 948095108, 2121516496,
            3145783543, 3317829736, 1747789312, 2531814391, 3890442684, 2818085288, 2464153947,
            1481243090, 276217925, 3528495726, 1905935399, 2226427326, 2086581637, 4057202032,
            359616860, 3056962263, 2860291775, 842289383, 2383199900, 970659426, 2493195055,
            2856530586, 1857349796, 1752828277, 2544869978, 347670364, 1697735707, 701641463,
            1495395009, 708234435, 71228858, 6725319, 3729042962, 1322267034, 3562179679, 390392117,
            2718661891, 4119722260, 3016165981, 173636303, 247793828, 2210075214, 2453528372,
            878495536, 4138879103, 3198938655, 1153023580, 3656466086, 1921278912, 4259770210,
            4025887727, 716454805, 2675991660, 764352060, 2061427150, 644202169, 410489069,
            1593496319, 1573762196, 3949934278, 3833307389, 2174149463, 559379456, 1359418491,
            997482747, 761315516, 1656437760, 2801700048, 3748972674, 2259204497, 1362944958,
            2946615863, 673289952, 940765530, 366736455, 1320319724, 1362593883, 3457327010,
            1134213393, 427373482, 3599931665, 1588374585, 1646426782, 509825313, 2001698005,
            1176187577, 2634244039, 1070336223, 3415726364, 215320212, 1449139043, 742200464,
            4209002780, 2288931600, 4229843766, 193606371, 3561138658, 4133177363, 2413226392,
            2496965490, 3644482506, 340536440, 2090666858, 1169098255, 2180302090, 1332098645,
            3519593925, 2034913842, 3228903288, 3590605244, 2043663430, 3898913249, 3419698288,
            1687179296, 426138261, 1800833856, 852965144, 1231468533, 1422804543, 371324314,
            3637780806, 1165909850, 1006939933, 1795186501, 1129865295, 3578796776, 1944628477,
            2325429195, 864154197, 1894479132, 2957055800, 3446306487, 1613516288, 1401983377,
            3217840062, 455266767, 3444044805, 3408708917, 67660920, 1130827181, 1226112436,
            2651987560, 2145498380, 843224815, 3345197520, 3247048414, 623892268, 2931986917,
            239431919, 1696049201, 3986120789, 26575503, 86884437, 4056010433, 1649158999,
            2384122627, 260528266, 3642906969, 299908390, 2053891086, 3661512858, 1351916795,
            2401047532, 4161527555, 3281787047, 697091227, 2783235332, 3810349867, 3643204404,
            746367499, 3391821244, 2910660296, 3113812611, 2108281660, 683621710, 1540660850,
            914865064, 3788165535, 714752705, 1131723309, 1256015046, 523998286, 3188590484,
            2727575505, 4140645458, 1289411501, 3165995413, 3352995463, 3791561200, 2673333513,
            4110565571, 305608709, 2009689483, 1860741830, 1345337841, 2755252410, 2950721341,
            659291128, 1227069782, 1415504028, 1569236383, 31519830, 2177707915, 562429604,
            2556441832, 3422139644, 915492748, 3074460773, 1135416931, 649823245, 645334249,
            2200862131, 1521286820, 2908520411, 3101024341, 625340248, 1363709939, 3604107235,
            936078234, 4012943112, 3989300683, 1639985469, 3243402231, 752354804, 1489406340,
            1457484819, 2059496004, 3672752421, 2323695461, 651127002, 628206064, 954208968,
            1528822556, 1147274155, 2206289820, 3236604581, 894257554, 1006545288, 2610663838,
            500086413, 1861737234, 1337328785, 1846887892, 3157530625, 978084610, 93655214,
            4272965685, 3324875949, 3280061343, 3738893064, 2946628304, 856234701, 3086444665,
            694808254, 1813880914, 4127555462, 2936029435, 2523356556, 2438706698, 1835377519,
            3004798523, 3255049351, 2645300243, 77871166, 3319880385, 4067278601, 3098242181,
            3325101113, 2772478697, 801534108, 1242913681, 1974780461, 3389506397, 1336588894,
            393129198, 2783030854, 2203427106, 1109383207, 1719283460, 3041243849, 261666695,
            1025535106, 923453286, 827717779, 2807039265, 1933118943, 3274244551, 1889699541,
            1265328665, 1943061121, 1042270043, 4002841458, 372231042, 325095059, 919156966,
            1559688844, 297972731, 1058124675, 3463490561, 4186279382, 2585599754, 4031687143,
            255362872, 2718851830, 2441505029, 3559629598, 161284861, 1992175784, 3915485134,
            84323157, 141131997, 2756061329, 179913101, 3330332543, 3136211599, 2603901635,
            4227256437, 2922178905, 616595963, 3175500824, 1655253586, 327289320, 3770920662,
            848693221, 3503841802, 3931259556, 1022855830, 2859936314, 513909550, 3999727525,
            2526957429, 2821984537, 2597122982, 1412326700, 3832231820, 3168678466, 2645115637,
            321303366, 2449201471, 2555994028, 3067904292, 4272299652, 3172742871, 2373897040,
            3262703632, 2201529522, 4242934543, 2919992911, 1436165986, 2033017928, 3066712322,
            3681817762, 3970838867, 2855719673, 506845064, 3660680647, 1903888229, 483654580,
            3933223724, 3283979865, 407468681, 1168530006, 2990704403, 815024928, 3889928435,
            2491617549, 1991884684, 3507821195, 1519742370, 3811922359, 621838161, 1818574590,
            1216501288, 3838181218, 1758746829, 3152172586, 3654785573, 4187946456, 962740404,
            1598170463, 1844781445, 1083364221, 914277180, 3307998213, 280531881, 3674295517,
            983896622, 3587758496, 3506890319, 612201946, 1594301102, 3557203990, 3452646665,
            746355999, 3219848916, 579876051, 2334310192, 1891407089, 675744779, 1079614653,
            1305614539, 22268105, 350406580, 2228346597, 4142391977, 3304705805, 2643224540,
            2346692777, 3811306839, 2055912668, 163083647, 2333826953, 2151057460, 3941937039,
            1085635170, 1112366764, 735116963, 2277711192, 3718251113, 3234345339, 3079451072,
            1597196335, 535008840, 3134500306, 2002330654, 1946854270, 2150715541, 1207738170,
            2635825461, 3280844938, 3595479391, 4046757619, 3676083000, 2521337294, 4211202760,
            1127070492, 463581130, 1572521594, 1362987995, 158041764, 2152374263, 560798666,
            2464343623, 647027940, 1153071868, 3545021547, 903696024, 1085151946, 3076244929,
            4071821109, 3577654894, 347719294, 1985137777, 506009938, 3043974844, 1224943034,
            2441674287, 943278257, 1345453507, 1693293667, 2900784417, 1631023524, 1765603555,
            1126325548, 2921853563, 2146353962, 998613971, 514840483, 1023293489, 3615741723,
            2369262290, 656145243, 1354305259, 2947584320, 4176666913, 2725299359, 3261612155,
            255828942, 3388332780, 3297000689, 1523045439, 3365583669, 486896888, 1170116441,
            3755093041, 2612246577, 4165702021, 634956699, 3768307260, 1328309876, 948878956,
            3444220003, 362000903, 2864691130, 507529696, 2930154584, 3635605629, 2886604763,
            1701207604, 650477935, 1278563275, 1152046466, 2842388098, 3155750550, 1913296439,
            3796154204, 1373623833, 1829190240, 2402164973, 3534925063, 1350190204, 3766380825,
            2884139564, 4000978894, 4250218774, 1694124076, 3647405317, 3450510830, 297575619,
            3239433082, 2321033644, 1593523758, 986488941, 927914435, 1041323457, 3052530576,
            4122441236, 3679849671, 1129141796, 3385482782, 3271988188, 1637458982, 3365075758,
            3327750380, 915073093, 3973890572, 2936228140, 3281245874, 3370332651, 801307974,
            3367310492, 4025581329, 3744265314, 3141527609, 783285243, 1024284631, 1662557967,
            4288387661, 3850518314, 3999781803, 3479141110, 1226667474, 2237093609, 1871582151,
            4030420346, 593353899, 2848318175, 4135113486, 3367015917, 126745884, 3109648786,
            3558908978, 3548495984, 3114288752, 3697000294, 2490559532, 3888775359, 358178714,
            1951854291, 2275007118, 4151980360, 298857474, 3736529133, 2961456632, 196996783,
            2454543290, 1339045573, 2697951962, 2819473132, 1306910810, 1735981146, 2695155186,
            4153090923, 3374802720, 2397801981, 410696114, 589256661, 1489109647, 975636822,
            3988780217, 1904014052, 2922748256, 708153852, 3861011602, 1222762022, 3096481891,
            3901201549, 1176473345, 2150797357, 1952018225, 104031537, 1424303343, 1792851996,
            1810265303, 2810033694, 1921090978, 2889572543, 2787907754, 1596110156, 260692140,
            3729584744, 716675854, 1179319491, 1796748177, 71608814, 1742751168, 2736750551,
            1914149388, 830787397, 1386733720, 3073223633, 1151062847, 1892436425, 2187447358,
            1977238084, 363476021, 3429583327, 402781814, 781128806, 4244331924, 2494700575,
            3735841530, 3001940434, 1301696657, 152848131, 1164018513, 2733754197, 3589134520,
            1972719071, 3795946134, 3112071646, 1810134638, 955771191, 849034716, 3543622175,
            2412624989, 1849274312, 2880121793, 1482761278, 2303516731, 687795802, 1932236885,
            277889281, 2644543154, 3349742966, 498944828, 3159123266, 2094448658, 949728498,
            2624370130, 2862797877, 3455600769, 1752853916, 3196084250, 251319934, 3798443074,
            447885757, 3109173711, 3333486255, 4136551940, 1851600054, 1273576027, 3889307657,
            1009210572, 2904428566, 4066366542, 81331318, 3077464197, 2504370765, 1914551841,
            3595673347, 2279275163, 2895614653, 4004322562, 2781486796, 557234246, 3240119385,
            1474375840, 1748689310, 3190126248, 832119346, 1656610142, 2089515031, 3173461525,
            3482745970, 3396179284, 2752402192, 2967125248, 1773637785, 529966979, 276760102,
            2667014268, 2129514719, 2947217782, 4065778689, 112424943, 3049102676, 455115487,
            1843393324, 896703959, 3863808184, 2285702025, 2527940087, 1194581980, 330894106,
            1235505341, 1239511919, 513391968, 1574835140, 2637052830, 1489734447, 3462608188,
            3853430832, 44976308, 1465077781, 2984715170, 1493217435, 3842116629, 4282698888,
            3942540872, 3310013608, 3043245350, 1118287730, 3535672347, 1225429595, 3996492203,
            521109925, 2780037099, 1788178032, 3363008600, 4159442270, 1279718880, 3336828392,
            3281491867, 3678359654, 2590189543, 1755642657, 3797171953, 3940770955, 2424081100,
            2985789408, 987668658, 895616615, 2619071987, 952588159, 530271896, 2255848659,
            996616018, 1480991213, 2375501561, 1135199032, 1010174044, 3663512884, 419279564,
            2134518764, 81322211, 2909309622, 334695784, 2390255124, 484096560, 1429331258,
            1695288986, 933327260, 1144889677, 2630062765, 4136242651, 1154319202, 4178377937,
            3871010999, 978633896, 1124790846, 3872961237, 2359087957, 2713332437, 2067169477,
            3218791441, 2417082480, 2950387228, 711207861, 3905938888, 1072297456, 780058137,
            2225327061, 66019917, 2101309172, 781732246, 2915984650, 907717265, 349157973,
            2571074611, 1836556611, 242912724, 3435716719, 3021264709, 608905744, 231754520,
            3628024202, 3540870844, 2698200065, 3370666951, 679176354, 873060091, 1824713668,
            2354137422, 3956522608, 3912379829, 2941940140, 1659750710, 3554891308, 2203113685,
            2970109543, 4016203021, 2190622424, 401362631, 2136413586, 506344911, 3328130215,
            2873829637, 3883674672, 1735707197, 2851213471, 3636007066, 3576142781, 920635286,
            3414277027, 755640444, 224699414, 477577470, 3046142152, 1393292158, 1434828494,
            1060405281, 1996479056, 2678833306, 2252179338, 860115768, 1116533040, 3018630432,
            112735461, 2035706152, 763718853, 2823484451, 1754287104, 2664502817, 3585354939,
            732548627, 2175348082, 233002529, 2019361456, 3523232597, 2101058708, 2130251156,
            3667165550, 1447145780, 1368365682, 1409672843, 2662508723, 3256925752, 2808642181,
            85804983, 3369281785, 1883595751, 1123696267, 616532342, 1678240924, 1393929910,
            2830042662, 3876251704, 1968769983, 1639145269, 49550780, 374866824, 110504714,
            3303116796, 2411786404, 3099711676, 1157367152, 692800170, 681888974, 1919966704,
            672504458, 2819918429, 1169544583, 936968114, 2520693949, 1435498099, 1156122806,
            2803887655, 128491806, 1027089845, 2700739409, 288869674, 2093162014, 1199366336,
            1452631673, 589696736, 910548969, 1944921731, 1078368879, 4155043530, 2493773362,
            2118362864, 3939034270, 3366844078, 3745811564, 952783004, 1650335956, 3883669193,
            770913022, 3405982998, 2619848605, 735716470, 1907987463, 3237980455, 1662385035,
            3017028838, 3524707041, 2392747612, 3722871952, 3263101367, 620748022, 2443637548,
            3324016375, 684174418, 3861376463, 1979953065, 519879078, 1047123184, 2446164799,
            2377242800, 2933899494, 41432330, 94026108, 3267986354, 4168280259, 2705573896,
            3360605438, 3365914548, 3406807268, 1995869767, 3669573002, 1845408832, 863506975,
            3404003784, 2126651504, 14799952, 2994833187, 4176848320, 452676058, 1664278670,
            893912181, 3784216926, 2669847142, 1014136786, 3801538065, 306096503, 1668645734,
            4127485751, 305365825, 3104772045, 1005162901, 3854879829, 2646981055, 4075778792,
            637633254, 2098343553, 4068135114, 3385210946, 140099086, 1225070629, 3389371958,
            1850430746, 73349102, 490078699, 1347332780, 875789524, 209085107, 1507865019,
            1210427799, 515723706, 1868027722, 2058975055, 4270443277, 1366025695, 105646624,
            1509788154, 890549141, 3908953447, 807341053, 224539810, 659547130, 2780704405,
            1861784153, 3419852638, 2071538606, 131798003, 2420415589, 3854683022, 4000833859,
            2684812347, 2088735124, 2700426241, 2640680156, 34053997, 3906621832, 1423946216,
            516493097, 2897244512, 3703450183, 3235085733, 2708698459, 3741097740, 1551680475,
            376177994, 351898921, 552249933, 922521851, 91876389, 1044244206, 1115857743,
            3521017455, 587340439, 2190908905, 1712180168, 323825696, 3387372619, 858685730,
            3729385118, 3805205604, 2378887338, 3718437268, 477040385, 3124665320, 1808730625,
            709692573, 1936795956, 562417108, 1963827974, 3538447015, 1782736438, 2457129116,
            3990965080, 1871133930, 2972028029, 3867007479, 597477621, 4254333800, 191676744,
            2731291088, 1756855263, 1507146434, 3101630736, 2053580818, 3087659003, 412528102,
            3666146766, 1864436374, 589191486, 3034015201, 2146647765, 2772471410, 819324439,
            1925031770, 4052060806, 3928995908, 2706898868, 595467632, 240328025, 334044202,
            3728473436, 624775586, 106994446, 1102919260, 42923722, 585566309, 3050414830,
            1510865011, 1098762897, 2583442585, 614228805, 2402539396, 770290105, 308031879,
            425687430, 1218449747, 2716558921, 1929243434, 1257229287, 2176542367, 706728595,
            2508641353, 1027518972, 3961844074, 2501009749, 172703717, 2790230787, 428147405,
            3484324062, 810177957, 4162401982, 2267452562, 752562144, 1024230228, 2679993640,
            3119356373, 1876755195, 4044474080, 3571275564, 1938373684, 2893917153, 1490860820,
            973674173, 858741651, 456556454, 1434026249, 814434097, 2033138969, 4101399879,
            1949227476, 2584791597, 1714626029, 3337395475, 26118094, 1868010440, 1981814574,
            2218139522, 2782093872, 3603407779, 631332877, 1807142192, 878520063, 356991133,
            1672471476, 2194833618, 3935901757, 2991388597, 1628214501, 2032168122, 1538003368,
            314370106, 1753143679, 915672542, 3509957993, 2105542408, 1414588250, 3985143727,
            1495656623, 322802058, 3824061544, 1469606935, 1632468337, 283337945, 3439221703,
            3298553199, 2289504381, 2045978609, 1429608058, 2785464005, 2773134905, 136757740,
            3445930290, 2463142191, 2629280359, 311480240, 4204965565, 410971468, 1113488820,
            3222795507, 2025087398, 1665466436, 3943908042, 2765449529, 1257311034, 3531720973,
            20854566, 4021342790, 3785433655, 2630218088, 3644807264, 3901371304, 3640948520,
            3863350694, 849148797, 1326141603, 68161277, 1841270523, 3554223789, 3438932258,
            3877847149, 3017846090, 3147387441, 3776462537, 3347070451, 2720210508, 4097699213,
            4174324637, 1587629731, 3444565438, 4187384763, 3418638828, 1707503688, 3341712856,
            3105001597, 1780597032, 1387803205, 4119973268, 390641452, 767760632, 2358376934,
            3024095833, 2271575256, 88914562, 1265060538, 3624171743, 3693253351, 2197037019,
            1711449662, 3127263788, 2011052893, 2342704676, 2923024911, 2056538871, 3732228102,
            1787620293, 3986983402, 3508033674, 787856342, 3876073650, 1021493958, 661311052,
            1284817664, 3510068761, 2160462585, 531089334, 2341862479, 2123225605, 2975069226,
            1454648120, 2709538076, 186380217, 51898702, 701714190, 3506612549, 3320428182,
            2859339848, 3533713154, 3089919192, 1882195296, 1485897784, 2486962360, 758415433,
            236079331, 1475515301, 4008271342, 3979313520, 1531588689, 3883571822, 2800232407,
            4037999571, 3652352852, 2280544750, 583718393, 19789151, 1332193092, 772436346,
            2742865239, 3119469865, 2267207740, 2140203778, 2177551680, 4020473607, 261823465,
            1931847234, 1585658818, 2547861539, 4015864930, 1958364072, 1428836105, 1679472026,
            585029714, 4006545224, 3411279427, 3792127768, 3175098739, 3969847819, 1483422140,
            765230573, 3736767369, 1706282872, 329305623, 1040695644, 1684881032, 1272407531,
            3420521971, 3522034443, 2810848885, 1835779799, 2719122496, 4237209588, 1286977410,
            1787800433, 4223355912, 1284776076, 556616816, 4282812965, 2160424700, 1382593239,
            2516045926, 1797407435, 500920808, 419547784, 2079330089, 3497103530, 3481439636,
            3862364895, 3265084289, 2879758787, 3683708282, 2112436418, 748366440, 1662479434,
            963293795, 1836902165, 953512895, 156893596, 3742477156, 1534951954, 9867783,
            1071123538, 826169636, 1473699940, 1398802769, 3489413400, 3279858489, 3207769749,
            1844726812, 3640642524, 2750335002, 764406419, 1596487257, 1499341750, 2073530828,
            1551767693, 2947058908, 1183294128, 2827044301, 4264376236, 3544323998, 4287124850,
            846655561, 1827068722, 3819523089, 2772662699, 352633126, 1158231489, 2562677750,
            3345612115, 1147418734, 1487887911, 3309945982, 3849891818, 3652696420, 394907872,
            3103434701, 918406158, 2768564891, 3147089136, 2907819317, 2888373797, 2787755534,
            3859514895, 4232431754, 4042962333, 1281492509, 4002419688, 2820985804, 1704023742,
            1644797208, 1173714635, 2408376672, 2375732576, 1415179609, 2602999317, 593531553,
            2176498712, 2695591207, 2883179730, 2694207120, 1125555211, 1563183910, 4258821389,
            3403046251, 4017944083, 2698730212, 3338185430, 3045691178, 575737880, 685139618,
            1589153891, 412178860, 1162633267, 1944345456, 1967006725, 1024255981, 3786327406,
            542804109, 4157467010, 1727500843, 3573604690, 2111353503, 368315225, 2520704128,
            1796561125, 1626435200, 2254886653, 128840242, 808001143, 1500739954, 2063642899,
            2587711609, 107802700, 4229794616, 2670693803, 207878725, 2495604032, 3109053527,
            546978918, 1043648137, 1631274412, 365839054, 2919485597, 3150710342, 1028492706,
            2619056173, 3962815864, 2475158716, 259533563, 1457916063, 3603646061, 3372366726,
            2731736922, 1515197060, 1109717083, 4066793286, 2853741238, 618499060, 3815610005,
            2645879110, 591389873, 4155648255, 1218458888, 2043318599, 4245099975, 2766607503,
            3739099184, 2225793897, 1669959178, 1638798981, 1052699271, 875834115, 1387274512,
            497897420, 378912777, 1229567296, 2979929820, 1234317587, 2242823157, 616076844,
            1198176565, 1697526339, 2952269296, 259510251, 2292463341, 1110763338, 2834419408,
            2243897317, 1357218200, 175777809, 1599835643, 2759933309, 2740298552, 1197317042,
            391179902, 1726063293, 1567600416, 562374088, 2697654974, 743885610, 3911955293,
            595978879, 2492978036, 395457576, 3679105244, 242145418, 3206358366, 2022718346,
            2508006231, 2700101394, 2199368386, 1551314058, 3883557458, 31200113, 362076179,
            3942542681, 2170957456, 1199261872, 1711076146, 1350016364, 1091747881, 1136504139,
            926715789, 3397378635, 669618995, 807042417, 3035670333, 3354691559, 2149754843,
            3267393448, 4110214699, 938638546, 2805826602, 2110240297, 1257861712, 3673175951,
            968345689, 2938600642, 230127878, 2501408740, 3127939871, 3854966148, 608822848,
            3708451507, 2424468861, 4143788443, 3575886569, 1861677604, 149446520, 3976299715,
            2890510284, 1519510981, 1432498595, 104357924, 3965381525, 1017803683, 2903665224,
            2408631199, 10279575, 903811517, 2659504123, 275520645, 555960480, 2962976657,
            3833820553, 3810980845, 3521925688, 3963447715, 4000932047, 2355064254, 1043006088,
            4081568384, 2669175964, 777710945, 3736663677, 2929722329, 932990103, 3516119447,
            470504753, 3693725292, 1240779264, 1628339353, 3979066608, 881829213, 4110505327,
            2808632111, 960805185, 1304389985, 2591031922, 1586405142, 1704897803, 325652170,
            2697134023, 834249473, 1541424001, 2934973207, 2581256919, 3936746829, 1723826973,
            3152187997, 3596020452, 120414603, 1848962662, 1124638409, 1008154130, 1002411255,
            2287996684, 140510448, 1550243287, 334959613, 4179574024, 3449843246, 485728905,
            3866347246, 1653540960, 911548578, 1902101785, 324446669, 2326552094, 3473905612,
            1850204311, 3210536218, 422961006, 2570390056, 1505254050, 2797016905, 537654640,
            3622538924, 192474565, 1663354207, 1705814826, 3326083849, 3982462806, 1122161436,
            1325027385, 1866891611, 2284363446,
        ]
            .span();
        let mut serialized_pk: Span<felt252> = array![
            1350675573, 3521007802, 3973994890, 3022267814, 412198850, 1242482149, 1155432711,
            1475004518,
        ]
            .span();
        let msg = words_from_hex(
            "1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b1b",
        );
        let sig: SphincsSignature = Serde::deserialize(ref serialized_sig).unwrap();
        let pk: SphincsPublicKey = Serde::deserialize(ref serialized_pk).unwrap();
        assert!(serialized_sig.is_empty());
        let res = verify_128s(msg.span(), sig, pk);
        assert_eq!(res, true);
    }
}
